<!doctype html>  
<html lang="en">  
    <head>  
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
        <meta charset="utf-8">  
        <title>Javascript Graphics Sample</title>  
        <meta name="description" content="Graphics Sample">  
<!--
        <script type="text/javascript" src="https://spectorcdn.babylonjs.com/spector.bundle.js"></script>
-->
        <script type="text/javascript" src="Graphics.js"></script>
        <script type="text/javascript" src="mem.js"></script>

        <script type="text/javascript">
            var allocator = null;
            var graphics = null;
            var program = null;

            function loop() {
                console.log("Looping");
            }

            function start() {
                // TODO: Both allocator and graphics are now up and running. Request files, and wait for loop.
                console.log("Starting");

                window.setInterval(loop, 16);
            }

            function init() {
                if (window.SPECTOR !== undefined) {
                    var spector = new SPECTOR.Spector();
                    spector.displayUI();
                }

                let importObject = {
                    module: {},
                    env: { }
                };

                // Create game allocator
                let heapSize = 32 * 1024 * 1024; // 32 MiB Heap
                let stackSize = 8 * 1024 * 1024; // 8 MiB Stack (compiled with 4...)
                let dataSize = 8 * 1024 * 1024; // 8 MiB Data

                allocator = new GameAllocator(heapSize + dataSize + stackSize, heapSize);
                allocator.InjectWebAssemblyImportObject(importObject);
                
                // Create graphics device
                const gl = document.getElementById('webglCanvas').getContext('webgl2');
                graphics = new GraphicsManager(gl, console.log);
                graphics.InjectWebAssemblyImportObject(importObject);

                WebAssembly.instantiateStreaming(fetch('GraphicsSample.wasm'), importObject).then(prog => {
                    program = prog;
                    allocator.InitializeWebAssembly(program.instance.exports);

                    // Set up allocator for gfx
                    program.instance.exports.wasmGraphics_SetGlobalAllocator(allocator.AllocatorPtr);
                    let allocate_mem = program.instance.exports.wasmGraphics_GetAlloceFunction();
                    let release_mem = program.instance.exports.wasmGraphics_GetReleaseFunction();
                    
                    // Initialize GFX
                    graphics.InitializeWebAssemblyDevice(allocate_mem, release_mem, program.instance.exports, allocator.memory);
                    
                    start();
                });
            }
        </script>
        <!--link rel="stylesheet" href="style.css" /-->
        <link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAvW8cAP///wCjoJ0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEREREQAAAAAiIiIiAAAAACIiIiIAAAAAIiIiIgAAAAAiIiIiAAAAACIiIiIAAAAAAAAAAAAAAAAAAAAAAAAAAAMzMzAAAAAAAzMAMAAAAAADMwAwAAAAAAMzADAAAAAAAAAAAAAAAAAAAAAAAAD//wAAwAMAAMADAADAAwAAwAMAAMADAADAAwAAwAMAAMADAADAAwAAwAMAAMADAADABwAAwA8AAP//AAD//wAA" rel="icon" type="image/x-icon" />
        <style>
            * {
                border: 0px;
                padding: 0px;
                margin: 0px;
                color: rgb(220, 220, 220);
                text-decoration: none;
                font-size: 14px;
                font-family: monospace;
            }
            html, body {
                min-height: 100% !important;
                min-width: 100% !important;
                height: 100%;
                width: 100%;

                background-color: rgb(0, 0, 0);
                color: rgb(220, 220, 220);
            }
        </style>
    </head>  
    <body onload="init();">
        <canvas id="webglCanvas" width="800" height="600"></canvas>
    </body>  
</html>